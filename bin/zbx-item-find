#!/usr/bin/env bash
set -euo pipefail
SD="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"; PATH="$SD:$PATH"
. "$SD/log-lib"; . "$SD/zbx-lib"
host="${1:-}"; key="${2:-}"
[ -z "$host" ] || [ -z "$key" ] && { echo "Usage: $(basename "$0") <host> <item-key-exact>"; exit 2; }
hid="$(jq -n --arg host "$host" '{filter:{host:$host}, output:["hostid"]}' | zbx_call host.get | jq -r '.result[0].hostid // empty')"
[ -z "$hid" ] && { log_error "Host not found: $host"; exit 1; }
jq -n --arg hid "$hid" --arg key "$key" '{hostids:[$hid], search:{key_:$key}, searchByAny:"true", output:["itemid","name","key_","value_type"]}' | zbx_call item.get | jq -r '.result[] | [.itemid,.value_type,.key_,.name]|@tsv'
