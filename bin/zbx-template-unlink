#!/usr/bin/env bash
set -euo pipefail
SD="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"; PATH="$SD:$PATH"
. "$SD/log-lib"; . "$SD/zbx-lib"
case "${1:-}" in
  -h|--help)
  cat <<'EOF'
Usage: zbx template-unlink <host> <template-name>

Unlink a template from a host.

Details:
  Removes the template from the host's linked templates.
EOF
    exit 0 ;;
esac
host="${1:-}"; template="${2:-}"
[ -z "$host" ] || [ -z "$template" ] && { echo "Usage: $(basename "$0") <host> <template-name>"; exit 2; }
hid="$(jq -n --arg host "$host" '{filter:{host:$host}, output:["hostid"]}' | zbx_call host.get | jq -r '.result[0].hostid // empty')"
[ -z "$hid" ] && { log_error "Host not found: $host"; exit 1; }
tid="$(jq -n --arg name "$template" '{filter:{name:$name}, output:["templateid"]}' | zbx_call template.get | jq -r '.result[0].templateid // empty')"
[ -z "$tid" ] && { log_error "Template not found: $template"; exit 1; }
jq -n --arg hid "$hid" --arg tid "$tid" '{hostid:$hid, templates_clear:[{templateid:$tid}]}' | zbx_call host.update | jq '.result'
