#!/usr/bin/env bash
set -euo pipefail
SD="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"; PATH="$SD:$PATH"
. "$SD/log-lib"; . "$SD/zbx-lib"
case "${1:-}" in
  -h|--help)
    cat <<'EOF'
Usage: cat macros.tsv | zbx macro-bulk-set

Bulk set host macros from TSV input.

Details:
  Input format: host<TAB>{MACRO}<TAB>value
EOF
    exit 0 ;;
esac
while IFS=$'\t' read -r host macro value; do
  [ -z "${host:-}" ] && continue
  hid="$(jq -n --arg host "$host" '{filter:{host:$host}, output:["hostid"]}' | zbx_call host.get | jq -r '.result[0].hostid // empty')"
  if [ -z "$hid" ]; then log_warn "skip: host not found: $host"; continue; fi
  jq -n --arg hid "$hid" --arg macro "$macro" --arg value "$value" '{hostid:$hid, macros:[{macro:$macro, value:$value}]}' | zbx_call host.update >/dev/null && echo "ok $host $macro"
done
