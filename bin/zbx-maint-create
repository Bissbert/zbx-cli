#!/usr/bin/env bash
set -euo pipefail
SD="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"; PATH="$SD:$PATH"
. "$SD/log-lib"; . "$SD/zbx-lib"
case "${1:-}" in
  -h|--help)
    cat <<'EOF'
Usage: zbx maint-create <name> <host> <since-epoch> <until-epoch>

Create a maintenance window for a host.

Details:
  Creates a one-off maintenance with the given time bounds.
EOF
    exit 0 ;;
esac
name="${1:-}"; host="${2:-}"; since="${3:-}"; until="${4:-}"
[ -z "$name" ] || [ -z "$host" ] || [ -z "$since" ] || [ -z "$until" ] && { echo "Usage: $(basename "$0") <name> <host> <since-epoch> <until-epoch>"; exit 2; }
hid="$(jq -n --arg host "$host" '{filter:{host:$host}, output:["hostid"]}' | zbx_call host.get | jq -r '.result[0].hostid // empty')"
[ -z "$hid" ] && { log_error "Host not found: $host"; exit 1; }
jq -n --arg name "$name" --arg since "$since" --arg until "$until" --arg hid "$hid" '{name:$name, active_since:($since|tonumber), active_till:($until|tonumber), hostids:[$hid]}' | zbx_call maintenance.create | jq '.result'
