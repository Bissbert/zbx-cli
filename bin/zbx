#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"
PATH="$SCRIPT_DIR:$PATH"

. "$SCRIPT_DIR/log-lib"

usage() {
  cat <<'EOF'
Usage: zbx <command> [args...]
Run "zbx help <command>" for help.
EOF
}

help_cmd="${1:-}"
if [ "${help_cmd:-}" = "-h" ] || [ "${help_cmd:-}" = "--help" ] || [ "${help_cmd:-}" = "help" -a "${2:-}" = "" ]; then
  usage; exit 0
fi

if [ "${help_cmd:-}" = "help" ] && [ -n "${2:-}" ]; then
  cmd="zbx-${2}"
  if command -v "$cmd" >/dev/null 2>&1; then
    "$cmd" -h || true
    exit 0
  else
    echo "Unknown command: $2"
    exit 2
  fi
fi

[ $# -lt 1 ] && { usage; exit 2; }

sub="$1"; shift || true
cmd="zbx-${sub}"

if ! command -v "$cmd" >/dev/null 2>&1; then
  echo "Unknown command: ${sub}"
  exit 2
fi

exec "$cmd" "$@"
