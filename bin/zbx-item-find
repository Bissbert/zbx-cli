#!/usr/bin/env bash
set -euo pipefail
# shellcheck disable=SC1007,SC2015,SC1090,SC1091
SD="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"; PATH="$SD:$PATH"
. "$SD/log-lib"; . "$SD/zbx-lib"
FORMAT=tsv; HEADERS=0
while [ $# -gt 0 ]; do
  case "${1:-}" in
    --format) FORMAT="${2:-tsv}"; shift ;;
    --headers) HEADERS=1 ;;
    -h|--help)
      cat <<'EOF'
Usage: zbx item-find <host> <item-key-exact>

Find items by exact key on a host.

Details:
  Output: TSV columns: itemid, value_type, key_, name.
  Options:
    --format {tsv|csv|json}  Output format (default: tsv)
    --headers                Print header row (tsv/csv only)
EOF
      exit 0 ;;
    *) break ;;
  esac
  shift || true
done

case "${1:-}" in
  -h|--help)
    cat <<'EOF'
Usage: zbx item-find <host> <item-key-exact>

Find items by exact key on a host.

Details:
  Output: TSV columns: itemid, value_type, key_, name.
  Options:
    --format {tsv|csv|json}  Output format (default: tsv)
    --headers                Print header row (tsv/csv only)
EOF
    exit 0 ;;
esac
host="${1:-}"; key="${2:-}"
[ -z "$host" ] || [ -z "$key" ] && { echo "Usage: $(basename "$0") <host> <item-key-exact>"; exit 2; }
hid="$(jq -n --arg host "$host" '{filter:{host:$host}, output:["hostid"]}' | zbx_call host.get | jq -r '.result[0].hostid // empty')"
[ -z "$hid" ] && { log_error "Host not found: $host"; exit 1; }
resp="$(jq -n --arg hid "$hid" --arg key "$key" '{hostids:[$hid], search:{key_:$key}, searchByAny:"true", output:["itemid","name","key_","value_type"]}' | zbx_call item.get)"
if [ "$FORMAT" = "json" ]; then jq '.result' <<<"$resp"; exit 0; fi
headers='["itemid","value_type","key_","name"]'
rows="$(jq -c '.result | map([.itemid,.value_type,.key_,.name])' <<<"$resp")"
zbx_format_rows "$FORMAT" "$headers" "$rows" "$HEADERS"
